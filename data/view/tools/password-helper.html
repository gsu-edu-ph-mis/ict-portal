{% extends "document.html" %}

{% block body %}
<div class="row">
    <div class="col-md-12 mb-5">
        <header class="text-center pl-4 pr-4">
            <img class="mb-4" width="150" height="150" src="/images/logo-ictu.png" alt="ICT Logo">
        </header>
    </div>
</div>
<div class="row align-items-center mb-5">
    <div id="vApp" v-cloak :data-pending="pending" class="col-md-8 m-auto text-center">
        <div class="login-form">
            <h1 class="h4 mb-5 mt-3">Password <span class="text-danger">Helper</span> </h1>
            <div class="form-group text-center d-flex">
                <input ref="passwordText" @focus="select($event)" v-model="password" type="text" readonly
                    class="text-center form-control" style="font-size: 30px;">
                <button @click="copy($event)" :disabled="disabled" class="btn btn-light btn-lg"
                    type="button">${btnCopyText}</button>
            </div>
            <div class="form-group text-left d-flex align-items-center">
                <label for="ptype" class="mb-0 mr-2">Type</label>
                <select v-model="ptype" name="ptype" id="ptype" class="form-control" style="width: 130px;">
                    <option value="1">Passphrase</option>
                    <option value="2">Password</option>
                    <option value="3">Passcode</option>
                </select>
                <label for="length" class="mb-0 ml-4 mr-2">Length</label>
                <select v-model="length" name="length" id="length" class="form-control" style="width: 100px;">
                    <option v-for="l,i in lengthList" :value="l">${l}</option>
                </select>
                <template v-if="ptype==1">
                    <label for="separator" class="mb-0 ml-4 mr-2">Separator</label>
                    <select v-model="separator" name="separator" id="separator" class="form-control"
                        style="width: 100px; font-size: 20px;">
                        <option value="-">-</option>
                        <option value="~">~</option>
                        <option value="_">_</option>
                        <option value="+">+</option>
                        <option value=".">.</option>
                    </select>
                </template>
            </div>
            <div class="form-group mt-5">
                <button @click="generate()" :disabled="disablePassword" class="btn btn-primary btn-lg"
                    type="button">${btnPasswordText}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    const vApp = new Vue({
        el: '#vApp',
        delimiters: ["${", "}"],
        mixins: [],
        data: {
            pending: false,
            ptype: 1,
            length: 4,
            separator: '-',
            password: '{{password}}',
            btnPasswordText: 'Generate',
            btnCopyText: 'Copy',
            disablePassword: false,
        },
        watch: {
            ptype: function (newVal) {
                if (newVal == 1 || newVal == 3) {
                    this.length = 4
                } else if (newVal == 2) {
                    this.length = 16
                }
            }
        },
        computed: {
            disabled: function () {
                return (!this.password)
            },
            lengthList: function () {
                if (this.ptype == 2) {
                    return [16, 32, 64, 128, 256]
                }
                return [4, 5, 6, 7, 8, 9, 10]

            }
        },
        methods: {
            getAsync: async (url) => {
                try {
                    let response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    if (!response.ok) {
                        throw new Error(await response.text())
                    }
                    return response.json();
                } catch (error) {
                    console.error(error)
                    throw error
                }
            },
            select: function (e) {
                const input = e?.target
                if (input) {
                    input.select()

                }
            },
            copy: function (e) {
                const me = this
                me.$refs.passwordText.select()
                me.$refs.passwordText.setSelectionRange(0, 99999); // For mobile devices
                navigator.clipboard.writeText(me.$refs.passwordText.value)
                me.btnCopyText = 'Copied'
                setTimeout(function(){
                    me.btnCopyText = 'Copy'
                }, 1000)
            },

            generate: async function (e) {
                const me = this
                me.disablePassword = true
                me.btnPasswordText = 'Generating'
                const resp = await me.getAsync(`/password-helper?ptype=${me.ptype}&length=${me.length}&separator=${me.separator}`)
                me.disablePassword = false
                me.btnPasswordText = 'Generate'

                if (resp) {
                    me.password = resp.password
                }
            }
        }
    })
</script>
{% endblock %}